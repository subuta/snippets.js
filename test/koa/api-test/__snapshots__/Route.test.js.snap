// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`koa/api-test/Route should create koa Route 1`] = `
"import test from 'ava'
import _ from 'lodash'
import sinon from 'sinon'
import request from 'supertest'
import {jwksEndpoint} from 'jwks-rsa/tests/mocks/jwks'
import {publicKey, privateKey} from 'jwks-rsa/tests/mocks/keys'
import {createToken} from 'jwks-rsa/tests/mocks/tokens'
import Koa from 'koa'
import importFresh from 'import-fresh'
import {absolutePath} from '../../config'
import {currentUser} from 'test/helper/user'
import runSeed, {runMigration} from 'test/helper/fixtures'
import proxyquire from 'proxyquire'

const sandbox = sinon.sandbox.create()

test.beforeEach(async (t) => {
  const knex = importFresh(absolutePath('src/utils/knex')).default

  await runMigration(knex)
  await runSeed(knex)

  const api = require('test/helper/mocked').api(knex)
  const models = require('test/helper/mocked').model(knex)

  const app = new Koa()
  // handle /api requests
  app.use(api.routes())
  app.use(api.allowedMethods())

  t.context = {
    ...models,
    request: request(app.listen(0))
  }
})

test.afterEach((t) => {
  sandbox.reset()
})

test('index should list user', async (t) => {
  const {request} = t.context

  // mock jwks
  const token = createToken(privateKey, '123', currentUser)
  jwksEndpoint('http://localhost', [{pub: publicKey, kid: '123'}])

  const response = await request
    .get('/api/users')
    .set('Authorization', \`Bearer \${token}\`)

  t.is(response.status, 200)
  t.deepEqual(response.body.length, 3)
  t.deepEqual(response.body, [19270, 82970, 93464])
})
test('show should return user', async (t) => {
  const {request} = t.context

  // mock jwks
  const token = createToken(privateKey, '123', currentUser)
  jwksEndpoint('http://localhost', [{pub: publicKey, kid: '123'}])

  const response = await request
    .get('/api/users/19270')
    .set('Authorization', \`Bearer \${token}\`)

  t.is(response.status, 200)

  t.deepEqual(response.body.id, 19270)
  t.deepEqual(response.body.auth0Id, 79736)
  t.deepEqual(response.body.locale, 'en_GB')
  t.deepEqual(response.body.nickname, 'Investment Account XSS')
  t.deepEqual(response.body.status, 'Fresh enhance')
  t.deepEqual(
    response.body.avatar,
    'https://s3.amazonaws.com/uifaces/faces/twitter/buzzusborne/128.jpg'
  )
  t.deepEqual(response.body.created_at, '2000-09-25T18:59:42.227Z')
  t.deepEqual(response.body.updated_at, '2000-09-15T04:49:30.128Z')
})
test('post should create user', async (t) => {
  const {request} = t.context

  // mock jwks
  const token = createToken(privateKey, '123', currentUser)
  jwksEndpoint('http://localhost', [{pub: publicKey, kid: '123'}])

  const response = await request
    .post('/api/users')
    .set('Authorization', \`Bearer \${token}\`)
    .send({
      article: {
        id: 90001,
        auth0Id: 60926,
        locale: 'en_BORK',
        nickname: 'neural',
        status: 'magenta Personal Loan Account',
        avatar:
          'https://s3.amazonaws.com/uifaces/faces/twitter/koridhandy/128.jpg',
        created_at: '2000-05-02T18:39:05.087Z',
        updated_at: '2000-03-17T02:59:20.639Z'
      }
    })

  t.is(response.status, 200)

  t.deepEqual(response.body.id, 90001)
  t.deepEqual(response.body.auth0Id, 60926)
  t.deepEqual(response.body.locale, 'en_BORK')
  t.deepEqual(response.body.nickname, 'neural')
  t.deepEqual(response.body.status, 'magenta Personal Loan Account')
  t.deepEqual(
    response.body.avatar,
    'https://s3.amazonaws.com/uifaces/faces/twitter/koridhandy/128.jpg'
  )
  t.deepEqual(response.body.created_at, '2000-05-02T18:39:05.087Z')
  t.deepEqual(response.body.updated_at, '2000-03-17T02:59:20.639Z')
})
test('update should update user', async (t) => {
  const {request} = t.context

  // mock jwks
  const token = createToken(privateKey, '123', currentUser)
  jwksEndpoint('http://localhost', [{pub: publicKey, kid: '123'}])

  const response = await request
    .put('/api/users/19270')
    .set('Authorization', \`Bearer \${token}\`)
    .send({
      article: {
        id: 19270,
        auth0Id: 60926,
        locale: 'en_BORK',
        nickname: 'neural',
        status: 'magenta Personal Loan Account',
        avatar:
          'https://s3.amazonaws.com/uifaces/faces/twitter/koridhandy/128.jpg',
        created_at: '2000-05-02T18:39:05.087Z',
        updated_at: '2000-03-17T02:59:20.639Z'
      }
    })

  t.is(response.status, 200)

  t.deepEqual(response.body.id, 19270)
  t.deepEqual(response.body.auth0Id, 60926)
  t.deepEqual(response.body.locale, 'en_BORK')
  t.deepEqual(response.body.nickname, 'neural')
  t.deepEqual(response.body.status, 'magenta Personal Loan Account')
  t.deepEqual(
    response.body.avatar,
    'https://s3.amazonaws.com/uifaces/faces/twitter/koridhandy/128.jpg'
  )
  t.deepEqual(response.body.created_at, '2000-05-02T18:39:05.087Z')
  t.deepEqual(response.body.updated_at, '2000-03-17T02:59:20.639Z')
})
test('delete should delete user', async (t) => {
  const {request, Article} = t.context

  let articles = await Article.query()
  t.deepEqual(articles.length, 3)

  // mock jwks
  const token = createToken(privateKey, '123', currentUser)
  jwksEndpoint('http://localhost', [{pub: publicKey, kid: '123'}])

  const response = await request
    .delete('/api/users/19270')
    .set('Authorization', \`Bearer \${token}\`)

  articles = await Article.query()
  t.deepEqual(articles.length, 2)

  t.is(response.status, 204)
  t.deepEqual(response.body, {})
})

/* mat Custom tests [start] */
/* mat Custom tests [end] */
"
`;
